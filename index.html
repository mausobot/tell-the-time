<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tell the Time! üïê</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--pink:#ec4899;--dark:#be185d;--light:#fce7f3;--bg:#fff1f2;--white:#fff}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:#1f2937;min-height:100vh;display:flex;justify-content:center;align-items:center}
.container{max-width:480px;width:100%;padding:20px;text-align:center}
h1{color:var(--dark);font-size:2.2em;margin-bottom:8px}
h2{color:var(--dark);font-size:1.5em;margin-bottom:16px}
.subtitle{color:var(--pink);font-size:1.1em;margin-bottom:24px}
button{background:var(--pink);color:var(--white);border:none;padding:14px 28px;border-radius:12px;font-size:1.1em;cursor:pointer;transition:all .2s;font-weight:600}
button:hover{background:var(--dark);transform:scale(1.05)}
button:active{transform:scale(.97)}
input[type=text]{padding:14px;border:3px solid var(--pink);border-radius:12px;font-size:1.1em;width:100%;max-width:300px;text-align:center;outline:none;margin-bottom:16px}
input[type=text]:focus{border-color:var(--dark);box-shadow:0 0 0 3px rgba(236,72,153,.2)}
.screen{display:none;animation:fadeIn .3s ease}
.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.clock-container{margin:20px auto;display:flex;justify-content:center}
canvas{border-radius:50%}
.digital-clock{font-family:'Courier New',monospace;font-size:3.5em;font-weight:bold;color:var(--dark);background:#1a0a10;padding:20px 36px;border-radius:16px;display:inline-block;text-shadow:0 0 10px var(--pink),0 0 20px var(--pink);letter-spacing:4px;border:3px solid var(--dark)}
.answers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:20px}
.answer-btn{background:var(--white);color:#1f2937;border:3px solid var(--light);padding:12px 8px;border-radius:12px;font-size:1em;font-weight:500;transition:all .2s;-webkit-tap-highlight-color:transparent;outline:none}
.answer-btn:hover{border-color:var(--pink);background:var(--light);transform:scale(1.03)}
.answer-btn:focus{outline:none;box-shadow:none}
.answer-btn.correct{background:#22c55e;color:var(--white);border-color:#16a34a}
.answer-btn.wrong{background:#ef4444;color:var(--white);border-color:#dc2626}
.progress{background:var(--light);border-radius:99px;height:10px;margin-bottom:16px;overflow:hidden}
.progress-bar{background:linear-gradient(90deg,var(--pink),var(--dark));height:100%;border-radius:99px;transition:width .4s ease}
.score-display{font-size:1.2em;color:var(--dark);font-weight:600;margin-bottom:8px}
.question-num{color:var(--pink);font-weight:600;margin-bottom:12px}
.leaderboard{text-align:left;margin:16px auto;max-width:360px}
.leaderboard table{width:100%;border-collapse:collapse}
.leaderboard th{background:var(--pink);color:var(--white);padding:8px 12px;font-size:.9em}
.leaderboard th:first-child{border-radius:8px 0 0 0}
.leaderboard th:last-child{border-radius:0 8px 0 0}
.leaderboard td{padding:8px 12px;border-bottom:1px solid var(--light);font-size:.9em}
.leaderboard tr:nth-child(even){background:var(--light)}
.leaderboard tr:first-child td{font-weight:700;color:var(--dark)}
.btn-group{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:16px}
.confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999}
.star{position:absolute;font-size:1.5em;animation:fall linear forwards}
@keyframes fall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
</style>
</head>
<body>
<div class="container">
<!-- WELCOME SCREEN -->
<div class="screen active" id="welcome">
<h1>üïê Tell the Time!</h1>
<p class="subtitle">Can you read the clock?</p>
<input type="text" id="nameInput" placeholder="Enter your name" maxlength="20" autofocus>
<br>
<button onclick="startGame()">Play! üéÆ</button>
<div class="btn-group" style="margin-top:20px">
<button onclick="showLeaderboard()" style="background:var(--light);color:var(--dark);font-size:.9em;padding:10px 20px">üèÜ Leaderboard</button>
</div>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="game">
<div class="score-display">Score: <span id="score">0</span></div>
<div class="question-num" id="qNum">Question 1 of 20</div>
<div class="progress"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
<div class="clock-container" id="clockContainer"></div>
<div class="answers" id="answers"></div>
</div>

<!-- RESULT SCREEN -->
<div class="screen" id="result">
<h1 id="resultEmoji">üåü</h1>
<h2 id="resultTitle">Well done!</h2>
<p class="subtitle" id="resultMsg"></p>
<div class="score-display" id="finalScore"></div>
<div id="resultBoard"></div>
<div class="btn-group">
<button onclick="startGame()">Play Again üîÑ</button>
<button onclick="showScreen('welcome')" style="background:var(--light);color:var(--dark)">Home</button>
</div>
</div>

<!-- LEADERBOARD SCREEN -->
<div class="screen" id="leaderboard">
<h2>üèÜ Leaderboard</h2>
<div id="lbContent"><p>Loading...</p></div>
<div class="btn-group">
<button onclick="showScreen('welcome')">Back</button>
</div>
</div>
</div>

<div class="confetti" id="confetti"></div>

<script>
const API='https://tell-the-time-api.cloudflarepages-585.workers.dev/api/scores';
let playerName='',score=0,qIndex=0,questions=[],qStart=0,locked=false;

const ROMAN=['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII'];

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}

function startGame(){
  playerName=document.getElementById('nameInput').value.trim()||'Player';
  score=0;qIndex=0;questions=generateQuestions();
  document.getElementById('score').textContent='0';
  showScreen('game');showQuestion();
}

function generateQuestions(){
  const qs=[];
  // Q1-5 easy
  const easyTimes=[[12,0],[3,0],[7,0],[2,30],[9,30],[6,15],[11,45],[4,15],[8,45],[1,30]];
  for(let i=0;i<5;i++){const t=easyTimes[i];qs.push({h:t[0],m:t[1],clockType:'numbered',diff:'easy'})}
  // Q6-10 medium
  const medMins=[5,10,20,25,35,40,50,55];
  for(let i=0;i<5;i++){const h=randInt(1,12),m=medMins[randInt(0,medMins.length-1)];qs.push({h,m,clockType:i<3?'numbered':'roman',diff:'medium'})}
  // Q11-15 hard
  for(let i=0;i<5;i++){const h=randInt(1,12),m=randEl([0,5,10,15,20,25,30,35,40,45,50,55]);qs.push({h,m,clockType:i<2?'roman':'unnumbered',diff:'hard'})}
  // Q16-20 hardest
  for(let i=0;i<5;i++){const h=randInt(1,12),m=randEl([0,5,10,15,20,25,30,35,40,45,50,55]);qs.push({h,m,clockType:i<3?'unnumbered':'digital',diff:'hardest'})}
  return qs;
}

function randInt(a,b){return a+Math.floor(Math.random()*(b-a+1))}
function randEl(a){return a[Math.floor(Math.random()*a.length)]}

function showQuestion(){
  if(qIndex>=20){endGame();return}
  locked=false;
  const q=questions[qIndex];
  document.getElementById('qNum').textContent=`Question ${qIndex+1} of 20`;
  document.getElementById('progressBar').style.width=((qIndex)/20*100)+'%';
  
  const container=document.getElementById('clockContainer');
  container.innerHTML='';
  if(q.clockType==='digital'){
    const d=document.createElement('div');d.className='digital-clock';
    d.textContent=`${q.h}:${q.m.toString().padStart(2,'0')}`;
    container.appendChild(d);
  } else {
    const c=document.createElement('canvas');c.width=220;c.height=220;
    container.appendChild(c);drawClock(c,q.h,q.m,q.clockType);
  }

  // Generate answers - digital clock must use word answers
  const useWords=q.clockType==='digital'||Math.random()<0.5;
  const correct=useWords?timeToWords(q.h,q.m):timeToDigit(q.h,q.m);
  const distractors=generateDistractors(q.h,q.m,useWords);
  const options=shuffle([correct,...distractors]);

  document.activeElement&&document.activeElement.blur();
  const answersDiv=document.getElementById('answers');
  answersDiv.innerHTML='';
  options.forEach(opt=>{
    const b=document.createElement('button');b.className='answer-btn';b.textContent=opt;
    b.addEventListener('touchend',e=>{e.preventDefault();selectAnswer(b,opt,correct)});
    b.onclick=e=>{if(e.pointerType!=='touch')selectAnswer(b,opt,correct)};answersDiv.appendChild(b);
  });
  qStart=Date.now();
}

function drawClock(canvas,h,m,type){
  const ctx=canvas.getContext('2d'),cx=110,cy=110,r=95;
  // Face
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
  ctx.lineWidth=4;ctx.strokeStyle='#ec4899';ctx.stroke();

  // Markings
  for(let i=1;i<=12;i++){
    const angle=(i*30-90)*Math.PI/180;
    if(type==='numbered'){
      ctx.font='bold 16px system-ui';ctx.fillStyle='#1f2937';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(i,cx+Math.cos(angle)*75,cy+Math.sin(angle)*75);
    } else if(type==='roman'){
      ctx.font='bold 13px system-ui';ctx.fillStyle='#1f2937';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(ROMAN[i-1],cx+Math.cos(angle)*75,cy+Math.sin(angle)*75);
    } else {
      const len=([12,3,6,9].includes(i))?12:6;
      const ox=Math.cos(angle),oy=Math.sin(angle);
      ctx.beginPath();ctx.moveTo(cx+ox*(r-4),cy+oy*(r-4));ctx.lineTo(cx+ox*(r-4-len),cy+oy*(r-4-len));
      ctx.lineWidth=[12,3,6,9].includes(i)?3:2;ctx.strokeStyle='#1f2937';ctx.stroke();
    }
  }

  // Center dot
  ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fillStyle='#be185d';ctx.fill();

  // Hour hand
  const hAngle=((h%12)+m/60)*30-90;
  const hr=hAngle*Math.PI/180;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(hr)*45,cy+Math.sin(hr)*45);
  ctx.lineWidth=6;ctx.lineCap='round';ctx.strokeStyle='#be185d';ctx.stroke();

  // Minute hand
  const mAngle=m*6-90;
  const mr=mAngle*Math.PI/180;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(mr)*70,cy+Math.sin(mr)*70);
  ctx.lineWidth=3;ctx.lineCap='round';ctx.strokeStyle='#1f2937';ctx.stroke();
}

function timeToWords(h,m){
  if(m===0) return h===12?"twelve o'clock":['one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve'][h-1]+" o'clock";
  const nums=['','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen','twenty'];
  const nextH=['twelve','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve'][h%12+1]||'one';
  const curH=['','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve'][h];
  if(m===15) return 'quarter past '+curH;
  if(m===30) return 'half past '+curH;
  if(m===45) return 'quarter to '+nextH;
  if(m<=30){
    const mw=m===5?'five':m===10?'ten':m===20?'twenty':m===25?'twenty-five':nums[m]||m+' minutes';
    return mw+' past '+curH;
  }
  const rem=60-m;
  const mw=rem===5?'five':rem===10?'ten':rem===20?'twenty':rem===25?'twenty-five':nums[rem]||rem+' minutes';
  return mw+' to '+nextH;
}

function timeToDigit(h,m){return h+':'+m.toString().padStart(2,'0')}

function generateDistractors(h,m,useWords){
  const set=new Set();
  const correct=useWords?timeToWords(h,m):timeToDigit(h,m);
  // Strategies: nearby minutes, swap hour, swap hands, random
  const tries=[[h,((m+5)%60)],[h,((m+55)%60)],[h,((m+15)%60)],[h,((m+30)%60)],
    [h%12+1,m],[(h+5)%12+1,m],[h%12+1,((m+30)%60)],[m%12||12,h*5%60],
    [(h+2)%12+1,m],[h,(m+10)%60],[h,(m+50)%60],[(h+6)%12+1,m]];
  for(const[dh,dm]of tries){
    if(set.size>=5)break;
    const s=useWords?timeToWords(dh,dm):timeToDigit(dh,dm);
    if(s!==correct)set.add(s);
  }
  while(set.size<5){
    const rh=randInt(1,12),rm=randEl([0,5,10,15,20,25,30,35,40,45,50,55]);
    const s=useWords?timeToWords(rh,rm):timeToDigit(rh,rm);
    if(s!==correct)set.add(s);
  }
  return[...set].slice(0,5);
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=randInt(0,i);[a[i],a[j]]=[a[j],a[i]]}return a}

function selectAnswer(btn,chosen,correct){
  if(locked)return;locked=true;
  const elapsed=(Date.now()-qStart)/1000;
  const btns=document.querySelectorAll('.answer-btn');
  if(chosen===correct){
    btn.classList.add('correct');
    const bonus=1+Math.max(0,(10-elapsed))/10;
    score+=Math.round(100*bonus);
    document.getElementById('score').textContent=score;
    setTimeout(()=>{qIndex++;showQuestion()},600);
  } else {
    btn.classList.add('wrong');
    btns.forEach(b=>{if(b.textContent===correct)b.classList.add('correct')});
    setTimeout(()=>{qIndex++;showQuestion()},2000);
  }
}

async function endGame(){
  document.getElementById('progressBar').style.width='100%';
  const pct=score/4000;
  const emoji=pct>=.8?'üåü':pct>=.5?'‚≠ê':'üí™';
  const title=pct>=.8?'Amazing!':pct>=.5?'Well done!':'Keep practising!';
  document.getElementById('resultEmoji').textContent=emoji;
  document.getElementById('resultTitle').textContent=title;
  document.getElementById('resultMsg').textContent=`${playerName}, you scored:`;
  document.getElementById('finalScore').textContent=score+' / 4000';
  showScreen('result');
  if(pct>=.5)spawnConfetti();
  try{
    const res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:playerName,score})});
    const data=await res.json();
    document.getElementById('resultBoard').innerHTML=renderBoard(data);
  }catch(e){document.getElementById('resultBoard').innerHTML='<p>Could not save score</p>'}
}

async function showLeaderboard(){
  showScreen('leaderboard');
  document.getElementById('lbContent').innerHTML='<p>Loading...</p>';
  try{
    const res=await fetch(API);const data=await res.json();
    document.getElementById('lbContent').innerHTML=renderBoard(data);
  }catch(e){document.getElementById('lbContent').innerHTML='<p>Could not load leaderboard</p>'}
}

function renderBoard(data){
  if(!data||!data.length)return'<p>No scores yet!</p>';
  let html='<div class="leaderboard"><table><tr><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr>';
  data.forEach((s,i)=>{
    const d=new Date(s.date).toLocaleDateString('en-GB',{day:'numeric',month:'short'});
    html+=`<tr><td>${i+1}</td><td>${esc(s.name)}</td><td>${s.score}</td><td>${d}</td></tr>`;
  });
  return html+'</table></div>';
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function spawnConfetti(){
  const c=document.getElementById('confetti');c.innerHTML='';
  const emojis=['‚≠ê','üåü','‚ú®','üíñ','ü©∑','üéÄ','ü¶Ñ','üå∏'];
  for(let i=0;i<40;i++){
    const s=document.createElement('div');s.className='star';s.textContent=randEl(emojis);
    s.style.left=Math.random()*100+'%';s.style.animationDuration=(2+Math.random()*2)+'s';
    s.style.animationDelay=(Math.random()*1.5)+'s';s.style.fontSize=(1+Math.random())+'em';
    c.appendChild(s);
  }
  setTimeout(()=>c.innerHTML='',5000);
}

document.getElementById('nameInput').addEventListener('keydown',e=>{if(e.key==='Enter')startGame()});
</script>
</body>
</html>
